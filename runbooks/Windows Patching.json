{"status":{},"contains_secrets":false,"product_version":"3.0.0.1","spec":{"description":"Installs Tools Needed to patch a server, reports pending patches and installs","resources":{"endpoint_definition_list":[],"client_attrs":{},"credential_definition_list":[],"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Update Service Check"},{"kind":"app_task","name":"Choco Check"},{"kind":"app_task","name":"PS Windows Updates Installed"},{"kind":"app_task","name":"Check Updates"}],"name":"604c2941_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Choco Check"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"PS Windows Updates Installed"}},{"from_task_reference":{"kind":"app_task","name":"PS Windows Updates Installed"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Check Updates"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Update Service Check","attrs":{"failure_child_reference":{"kind":"app_task","name":"94497133_FAILURE_META"},"exit_status":[],"script":"$services = get-service;\n$WUpdateService = $services | where {$_.name -eq \"wuauserv\"}\n$status = $WUpdateService | Get-Service | select -property name,starttype\nif ($status.StartType -eq \"Disabled\"){ write-error \"lets start this service\"}","success_child_reference":{"kind":"app_task","name":"c4e76088_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"No service change needed"}],"name":"c4e76088_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"No service change needed","attrs":{"type":"","interval_secs":1},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Enable Service"},{"kind":"app_task","name":"Update Service Check_3"}],"name":"94497133_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Enable Service","attrs":{"script":"$services = get-service;\n$WUpdateService = $services | where {$_.name -eq \"wuauserv\"}\n$WUpdateService | Set-Service -StartupType Automatic\n$WUpdateService | start-service","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Update Service Check_3","attrs":{"exit_status":[],"script":"write \"EnableService=1\"","eval_variables":["EnableService"],"eval_scope":"local","type":"","script_type":"npsscript"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Choco Check","attrs":{"failure_child_reference":{"kind":"app_task","name":"d71f3ae3_FAILURE_META"},"exit_status":[],"script":"choco -?","success_child_reference":{"kind":"app_task","name":"924ad7b4_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Already Installed Choco "}],"name":"924ad7b4_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Already Installed Choco ","attrs":{"type":"","interval_secs":1},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install Choco"}],"name":"d71f3ae3_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install Choco","attrs":{"script":"write \"Installing Chocolatey\"\nsleep 1\nSet-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https:\/\/chocolatey.org\/install.ps1'))","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"PS Windows Updates Installed","attrs":{"failure_child_reference":{"kind":"app_task","name":"534fef16_FAILURE_META"},"exit_status":[],"script":"Import-Module PSWindowsUpdate","success_child_reference":{"kind":"app_task","name":"5f210670_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Already Installed PSWIndowsUpdates"}],"name":"5f210670_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Already Installed PSWIndowsUpdates","attrs":{"type":"","interval_secs":1},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Install PSWindowsUpdate"},{"kind":"app_task","name":"Pending Reboot"}],"name":"534fef16_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install PSWindowsUpdate","attrs":{"script":"choco install pswindowsupdate -y","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Pending Reboot","attrs":{"failure_child_reference":{"kind":"app_task","name":"05495c74_FAILURE_META"},"exit_status":[],"script":"function Test-PendingReboot\n{\n if (Get-ChildItem \"HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Component Based Servicing\\RebootPending\" -EA Ignore) { return $true }\n if (Get-Item \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\WindowsUpdate\\Auto Update\\RebootRequired\" -EA Ignore) { return $true }\n if (Get-ItemProperty \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\" -Name PendingFileRenameOperations -EA Ignore) { return $true }\n try { \n   $util = [wmiclass]\"\\\\.\\root\\ccm\\clientsdk:CCM_ClientUtilities\"\n   $status = $util.DetermineIfRebootPending()\n   if(($status -ne $null) -and $status.RebootPending){\n     return $true\n   }\n }catch{}\n\n return $false\n}\n$reboot = Test-PendingReboot\nif ($reboot) {\n  write-error \"We need a reboot\"\n}","success_child_reference":{"kind":"app_task","name":"a77e3c3d_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"No Reboot Needed"}],"name":"a77e3c3d_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"No Reboot Needed","attrs":{"type":"","interval_secs":1},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Executing Reboot"},{"kind":"app_task","name":"Sleep Reboot"}],"name":"05495c74_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Executing Reboot","attrs":{"script":"shutdown -r -t 5","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep Reboot","attrs":{"type":"","interval_secs":90},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Check Updates","attrs":{"failure_child_reference":{"kind":"app_task","name":"dde00b2f_FAILURE_META"},"exit_status":[],"script":"$updates = Get-WindowsUpdate\nif ($updates) {\n  write $updates;\n  write-error \"lets install this\"\n}","success_child_reference":{"kind":"app_task","name":"13c3a6be_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"No Updates"}],"name":"13c3a6be_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"No Updates","attrs":{"failure_child_reference":{"kind":"app_task","name":"a8a15a3b_FAILURE_META"},"exit_status":[],"script":"if (\"@@{EnableService}@@\" -eq 1){\n  write-error \"Disabling Service Again\"\n}","success_child_reference":{"kind":"app_task","name":"d4df9668_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"No Service Change"}],"name":"d4df9668_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"No Service Change","attrs":{"type":"","interval_secs":1},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"DisalbeService2"}],"name":"a8a15a3b_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DisalbeService2","attrs":{"script":"$services = get-service;\n$WUpdateService = $services | where {$_.name -eq \"wuauserv\"}\n$WUpdateService | stop-service\n$WUpdateService | Set-Service -StartupType Disabled","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Updates Needed"}],"name":"dde00b2f_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"d9b35fc1_1_META"}],"name":"Updates Needed","attrs":{"loop_variable":"iteration","exit_condition_type":"on_success","type":"","iterations":"25"},"timeout_secs":"0","type":"WHILE_LOOP","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Installing"},{"kind":"app_task","name":"Sleep 10 Min"},{"kind":"app_task","name":"Patch Status"}],"name":"d9b35fc1_1_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Installing","attrs":{"script":"write \"Installing the following updates.\"\nget-windowsupdate\n$task = get-scheduledtask \"Patching\" -ea:4\nif ($task.state -eq \"Ready\" -or !$task){\n  get-scheduledtask \"Patching\" -ea:4 | Unregister-scheduledtask -Confirm:0  -ea:4\n  write \"Creating Task\"\n  $taskname = \"Patching\"\n  [array]$script += 'start-transcript C:\\windows\\temp\\wu.log'\n  $script += 'write \"Adding MSUpdate Repository\"'\n  $script += 'Add-WUServiceManager -ServiceID 7971f918-a847-4430-9279-4a52d1efe18d -confirm:0'\n  $script += '$updates = Get-WindowsUpdate -MicrosoftUpdate'\n  $script += 'foreach ($update in $updates){'\n  $script += '  write \"Installing update $($Update.kb)\"'\n  $script += '  Install-WindowsUpdate -KBArticleID $update.KB -AcceptAll'\n  $script += '  write \"Installing update $($Update.kb) Completed\"'\n  $script += '}'\n  $script | out-file c:\\windows\\temp\\Psupdate.ps1 -encoding ascii\n  $taskdescription = \"Installing Windows Patches\"\n  $action = New-ScheduledTaskAction -Execute 'Powershell.exe' -Argument '-File c:\\windows\\temp\\Psupdate.ps1'\n  $trigger =  New-ScheduledTaskTrigger -AtStartup -RandomDelay (New-TimeSpan -minutes 3)\n  $settings = New-ScheduledTaskSettingsSet -ExecutionTimeLimit (New-TimeSpan -Minutes 45) -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)\n  \n  write \"Registering task\"\n\n  Register-ScheduledTask -Action $action -Trigger $trigger -TaskName $taskname -Description $taskdescription -Settings $settings -User \"System\"\n  sleep 5\n\n  write \"Starting task\"\n\n  Start-ScheduledTask $taskname\n\n  sleep 5\n\n  $task = get-scheduledtask \"Patching\"\n  \n\n} else {\n\n  write \"Were still Patching\"\n  \n  get-content C:\\windows\\temp\\wu.log\n}","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep 10 Min","attrs":{"type":"","interval_secs":600},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Patch Status","attrs":{"failure_child_reference":{"kind":"app_task","name":"7490583a_FAILURE_META"},"exit_status":[],"script":"$task = get-scheduledtask \"Patching\" -ea:4\nif ($task.state -eq \"Running\"){\n  write \"Still installing patches\"\n} else {\n  write-error \"Were done\"\n}","success_child_reference":{"kind":"app_task","name":"8b86b34b_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Sleep 5 min"},{"kind":"app_task","name":"Wait for Patching"}],"name":"8b86b34b_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Sleep 5 min","attrs":{"type":"","interval_secs":300},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Wait for Patching","attrs":{"script":"write-error \"We are not done yet\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Reboot"}],"name":"7490583a_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Reboot","attrs":{"failure_child_reference":{"kind":"app_task","name":"6d4085ac_FAILURE_META"},"exit_status":[],"script":"get-scheduledtask \"RebootStatus\" -ea:4 | Unregister-scheduledtask -Confirm:0 -ea:4\nwrite \"Creating Task\"\n$taskname = \"RebootStatus\"\n$taskdescription = \"Installing Windows Patches\"\n$action = New-ScheduledTaskAction -Execute 'Powershell.exe' -Argument '-NoProfile -WindowStyle Hidden -command \"Get-WURebootStatus | out-file c:\\windows\\temp\\rebootstatus.log\"'\n$trigger =  New-ScheduledTaskTrigger -AtStartup -RandomDelay (New-TimeSpan -minutes 3)\n$settings = New-ScheduledTaskSettingsSet -ExecutionTimeLimit (New-TimeSpan -Minutes 2) -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)\n\nwrite \"Registering task\"\n\nRegister-ScheduledTask -Action $action -Trigger $trigger -TaskName $taskname -Description $taskdescription -Settings $settings -User \"System\"\nsleep 5\n\nwrite \"Starting task\"\n\nStart-ScheduledTask $taskname\n\nsleep 5\n\n$reboot = get-content \"c:\\windows\\temp\\rebootstatus.log\"\n\nif ($reboot -notmatch \"Reboot is not Required.\"){\n  write-error \"Reboot\"\n}\n\nremove-item \"c:\\windows\\temp\\rebootstatus.log\"","success_child_reference":{"kind":"app_task","name":"c94a98b6_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Clean"},{"kind":"app_task","name":"More"}],"name":"c94a98b6_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Clean","attrs":{"script":"get-scheduledtask \"Patching\" -ea:4 | Unregister-scheduledtask -confirm:0","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"More","attrs":{"failure_child_reference":{"kind":"app_task","name":"7bfa186c_FAILURE_META"},"exit_status":[],"script":"$updates = Get-WindowsUpdate\nif ($updates) {\n  write $updates;\n  write-error \"lets install this\"\n}","success_child_reference":{"kind":"app_task","name":"06c3f596_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"EnableService"}],"name":"06c3f596_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"EnableService","attrs":{"failure_child_reference":{"kind":"app_task","name":"137b938a_FAILURE_META"},"exit_status":[],"script":"if (\"@@{EnableService}@@\" -eq 1){\n  write-error \"Disabling Service Again\"\n}","success_child_reference":{"kind":"app_task","name":"4340135f_SUCCESS_META"},"type":"","command_line_args":"","script_type":"npsscript"},"timeout_secs":"0","type":"DECISION","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Exit1"}],"name":"4340135f_SUCCESS_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Exit1","attrs":{"type":"","interval_secs":1},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"DisableService1"}],"name":"137b938a_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DisableService1","attrs":{"script":"$services = get-service;\n$WUpdateService = $services | where {$_.name -eq \"wuauserv\"}\n$WUpdateService | stop-service\n$WUpdateService | Set-Service -StartupType Disabled","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"RestartLoop"}],"name":"7bfa186c_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"RestartLoop","attrs":{"script":"write-error \"looping back in\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Rebooting"},{"kind":"app_task","name":"Reboot sleep"},{"kind":"app_task","name":"Loop Retrun"}],"name":"6d4085ac_FAILURE_META","attrs":{"type":""},"timeout_secs":"0","type":"META","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Rebooting","attrs":{"script":"shutdown -r -t 10","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Reboot sleep","attrs":{"type":"","interval_secs":600},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Loop Retrun","attrs":{"script":"write-error \"Looping back in\"","type":"","command_line_args":"","exit_status":[],"script_type":"npsscript"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"af3ba4cf_runbook","main_task_local_reference":{"kind":"app_task","name":"604c2941_dag"},"variable_list":[{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"EnableService","value":"0","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}},"name":"Windows Patching"},"api_version":"3.0","metadata":{"last_update_time":"1593773282825666","kind":"runbook","spec_version":0,"creation_time":"1593773282825666","name":"Windows Patching"}}